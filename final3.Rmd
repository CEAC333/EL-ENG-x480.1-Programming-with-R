---
title: "Programming with R: Final Exam"
author: "Heather Savoy"
date: "10/04/2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This PDF describes the problem statement for the third problem for our final exam. Write one .R script (or, optionally, a .Rmd) that addresses the problem described below. Upload your script to Question 3 of the **Final Exam (Timed)** assignment.  


## Problem 3
This problem is an expansion of Exercise 6 in which you tested two assumptions when calculating prediction and confidence intervals from linear regression: that the residals are normally distributed and their mean is zero. You had written a script to test these two hypotheses for a particular dataset. Now, your goal is to write a function that does a similar process for general data. Your function should have the following features:

* It takes five input arguments
     + The vector of the independent variable data (required)
     + The vector of the dependent variable data (required)
     + A tolerance value for correlation to check against (default value of 0.5)
     + An alpha value for interpreting the hypothesis tests (default value of 0.05)
     + A vector of values for the independent variable from which to predict the dependent variable (default to a 100-length sequence of values from the minimum to the maximum value provided in the first input argument)
* It performs the following checks:
     + Calculate the correlation of the given data and compare to the tolerance value
          + If less than the threshold, print a message to the screen saying the correlation is too low and then call `return(NULL)`.
          + If greater than the threshold, move to the next step.
     + Fit a linear model with `lm` and store the residuals
     + Perform the Shapiro test to test normality and store the p-value. 
          + If the p-value is less than alpha, then print a message to the screen saying the assumption is not met and then only return the lm object.
          + If the p-value is greater than alpha, move to the next step.
     + Perform the t-test to test the mean and store the p-value. 
          + If the p-value is less than alpha, then print a message to the screen saying the assumption is not met and then only return the lm object.
          + If the p-value is greater than alpha, move to the next step.
     + Predict the dependent variable plus the prediction intervals.
     + Return a dataframe with a column for the independent variable, predicted dependent variable, lower prediction interval bound, and upper prediction interval bound. 

Test your function on the `faithful` dataset as in Exercise 9 (which should pass all your checks and return the dataframe). Then also test it with predicting mpg from hp in the mtcars dataset (which should fail the normality assumption and not return the dataframe). 

```{r, include=FALSE}
linPred <- function(indep, dep, 
                    corTol = 0.5, alpha = 0.05, 
                    eval = seq(min(indep), max(indep), length.out=20)){
  df <- data.frame(indep, dep)
  corel <- cor(df$indep, df$dep)
  if( abs(corel) < corTol) {
    cat("Correlation too low to warrant linear regression.\n")
    return(NULL)
  } else {
    fit <- lm(dep ~ indep, df)
    shapiroP <- shapiro.test(fit$residuals)$p.value
    if(shapiroP < alpha){
      cat("Residuals not normal. Returning lm object only.\n")
      return(fit)
    } else {
      tP <- t.test(fit$residuals)$p.value
      if(tP < alpha){
        cat("Residuals not zero mean. Returning lm object only.\n")
        return(fit)
      } else {
        pred <- predict(fit, data.frame(indep=eval), interval="prediction")
        return(data.frame(indep=eval, pred))
      }
    }
  }
}

linPred(faithful$waiting, faithful$eruptions)

linPred(mtcars$hp, mtcars$mpg)
```

